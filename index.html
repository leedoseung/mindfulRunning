<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë§ˆì¸ë“œí’€ëŸ¬ë‹ ê¸°ë¡</title>

    <!-- íŒŒë¹„ì½˜ ë° í™ˆí™”ë©´ ì•„ì´ì½˜ -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" href="/favicon.ico" />
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#667eea" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="apple-mobile-web-app-title" content="ë§ˆì¸ë“œí’€ëŸ¬ë‹" />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .container {
        background: white;
        border-radius: 20px;
        padding: 40px;
        max-width: 600px;
        width: 100%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }

      h1 {
        color: #667eea;
        margin-bottom: 10px;
        font-size: 28px;
        text-align: center;
      }

      .subtitle {
        text-align: center;
        color: #666;
        margin-bottom: 30px;
        font-size: 14px;
      }

      .form-group {
        margin-bottom: 20px;
        position: relative;
        clear: both;
      }

      label {
        display: block;
        margin-bottom: 8px;
        color: #333;
        font-weight: 500;
        font-size: 14px;
        clear: both;
      }

      .select-wrapper {
        position: relative;
        margin-bottom: 10px;
      }

      #nameSearch {
        margin-bottom: 8px;
        -webkit-appearance: none;
        appearance: none;
      }

      .suggestions {
        position: absolute;
        width: 100%;
        max-height: 0;
        overflow: hidden;
        background: white;
        border: 0;
        border-radius: 10px;
        margin-top: 5px;
        z-index: 1000;
        transition: max-height 0.2s ease, border 0.2s ease;
        box-shadow: none;
      }

      .suggestions.show {
        max-height: 250px;
        overflow-y: auto;
        border: 2px solid #667eea;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .suggestion-item {
        padding: 12px 15px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background 0.2s;
      }

      .suggestion-item:last-child {
        border-bottom: none;
      }

      .suggestion-item:hover {
        background: #f8f9fa;
      }

      .suggestion-item:active {
        background: #667eea;
        color: white;
      }

      .suggestion-item .name {
        font-weight: 600;
        color: #333;
      }

      .suggestion-item .details {
        font-size: 12px;
        color: #666;
        margin-top: 2px;
      }

      .suggestion-item:active .name,
      .suggestion-item:active .details {
        color: white;
      }

      /* iOS Safari í˜¸í™˜ì„± */
      @supports (-webkit-overflow-scrolling: touch) {
        .suggestions {
          -webkit-overflow-scrolling: touch;
        }
      }

      /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
      @media (max-width: 768px) {
        .container {
          padding: 20px;
        }

        body {
          -webkit-text-size-adjust: 100%;
        }
      }

      .member-count {
        font-size: 12px;
        color: #999;
        margin-top: 5px;
      }

      /* ë‚ ì§œ input ê°œì„  */
      input[type="date"] {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        line-height: normal;
        position: relative;
      }

      input[type="date"]::-webkit-date-and-time-value {
        text-align: left;
      }

      input[type="date"]::-webkit-calendar-picker-indicator {
        cursor: pointer;
        opacity: 1;
      }

      /* iOS Safari ë‚ ì§œ input ìˆ˜ì • */
      @supports (-webkit-touch-callout: none) {
        input[type="date"] {
          min-height: 44px;
        }
      }

      .required {
        color: #e74c3c;
      }

      input[type="text"],
      input[type="date"],
      input[type="number"],
      select,
      textarea {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 15px;
        transition: border-color 0.3s;
        font-family: inherit;
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: #667eea;
      }

      textarea {
        resize: vertical;
        min-height: 80px;
      }

      .description {
        font-size: 12px;
        color: #999;
        margin-top: 5px;
      }

      button {
        width: 100%;
        padding: 15px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        margin-top: 10px;
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
      }

      button:active {
        transform: translateY(0);
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .result-container {
        display: none;
        margin-top: 30px;
        padding: 25px;
        background: #f8f9fa;
        border-radius: 10px;
        border: 2px solid #667eea;
      }

      .result-container.show {
        display: block;
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .result-text {
        white-space: pre-wrap;
        font-size: 14px;
        line-height: 1.8;
        color: #333;
        margin-bottom: 15px;
        padding: 15px;
        background: white;
        border-radius: 8px;
        font-family: "Courier New", monospace;
      }

      .copy-button {
        background: #10b981;
        margin-bottom: 10px;
      }

      .copy-button:hover {
        box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
      }

      .leaderboard-button {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      }

      .leaderboard-button:hover {
        box-shadow: 0 10px 20px rgba(245, 158, 11, 0.3);
      }

      .success-message {
        text-align: center;
        color: #10b981;
        font-weight: 600;
        margin-top: 10px;
        display: none;
      }

      .success-message.show {
        display: block;
        animation: fadeIn 0.3s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .error-message {
        color: #e74c3c;
        font-size: 14px;
        margin-top: 10px;
        text-align: center;
        display: none;
      }

      .error-message.show {
        display: block;
      }

      .loading {
        text-align: center;
        color: #667eea;
        display: none;
      }

      .loading.show {
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸƒâ€â™‚ï¸ ë§ˆì¸ë“œí’€ëŸ¬ë‹ ê¸°ë¡</h1>
      <p class="subtitle">ì˜¤ëŠ˜ì˜ ë§ˆìŒì„ ê¸°ë¡í•˜ê³  ê³µìœ í•´ë³´ì„¸ìš”</p>

      <form id="runningForm">
        <div class="form-group">
          <label>ì´ë¦„ <span class="required">*</span></label>
          <div class="select-wrapper">
            <input
              type="text"
              id="nameSearch"
              placeholder="ì´ë¦„ ê²€ìƒ‰..."
              autocomplete="off"
              required
            />
            <input type="hidden" id="selectedMemberId" required />
            <div id="suggestions" class="suggestions"></div>
            <div class="member-count" id="memberCount"></div>
          </div>
        </div>

        <div class="form-group">
          <label>ë‹¬ë¦° ë‚ ì§œ <span class="required">*</span></label>
          <input type="date" id="date" required />
        </div>

        <div class="form-group">
          <label>ë‹¬ë¦° ì‹œê°„(ë¶„) <span class="required">*</span></label>
          <input
            type="number"
            id="duration"
            min="1"
            placeholder="ì˜ˆ: 30"
            required
          />
        </div>

        <div class="form-group">
          <label>ì˜¤ëŠ˜ì˜ í•œì¤„ ì œëª©/Story <span class="required">*</span></label>
          <input
            type="text"
            id="title"
            placeholder="ì˜¤ëŠ˜ì˜ ë‹¬ë¦¬ê¸°ë¥¼ í•œ ë¬¸ì¥ìœ¼ë¡œ"
            required
          />
        </div>

        <div class="form-group">
          <label>ë‹¬ë¦¬ê¸° ì „ ìƒê°/ëŠë‚Œ <span class="required">*</span></label>
          <textarea
            id="before"
            placeholder="ë¬¸ ë°–ì„ ë‚˜ì„œê¸° ì „, ëª¸ê³¼ ë§ˆìŒì€ ì–´ë–¤ ìƒíƒœì˜€ë‚˜ìš”?"
            required
          ></textarea>
          <p class="description">
            í”¼ë¡œ, ê¸°ëŒ€, ì €í•­, ì„¤ë ˜... ë¬´ì—‡ì´ë“  ê´œì°®ìŠµë‹ˆë‹¤
          </p>
        </div>

        <div class="form-group">
          <label>ë‹¬ë¦¬ê¸° ì¤‘ ìƒê°/ëŠë‚Œ <span class="required">*</span></label>
          <textarea
            id="during"
            placeholder="ë‹¬ë¦¬ëŠ” ë™ì•ˆ ë¬´ì—‡ì„ ì•Œì•„ì°¨ë ¸ë‚˜ìš”?"
            required
          ></textarea>
          <p class="description">
            ë°œì´ ë•…ì— ë‹¿ëŠ” ê°ê°, í˜¸í¡ì˜ ë¦¬ë“¬, ìŠ¤ì³ê°„ ìƒê°ë“¤...
          </p>
        </div>

        <div class="form-group">
          <label>ë‹¬ë¦¬ê¸° í›„ ìƒê°/ëŠë‚Œ <span class="required">*</span></label>
          <textarea
            id="after"
            placeholder="ë©ˆì¶”ê³  ë‚œ ë’¤ì˜ ë‚˜ëŠ” ì–´ë• ë‚˜ìš”?"
            required
          ></textarea>
          <p class="description">ë‹¬ë¦¬ê¸° ì „ì˜ ë‚˜ì™€ ë¬´ì—‡ì´ ë‹¬ë¼ì¡Œë‚˜ìš”?</p>
        </div>

        <button type="submit">ğŸ“ ê¸°ë¡í•˜ê¸°</button>
        <div class="loading">â³ Notionì— ì €ì¥ ì¤‘...</div>
        <div class="error-message"></div>
      </form>

      <div class="result-container" id="resultContainer">
        <div class="result-text" id="resultText"></div>
        <button class="copy-button" onclick="copyToClipboard()">
          ğŸ“‹ ë³µì‚¬í•˜ê¸°
        </button>
        <button class="leaderboard-button" onclick="goToLeaderboard()">
          ğŸ† ë¦¬ë”ë³´ë“œ ë³´ëŸ¬ê°€ê¸°
        </button>
        <div class="success-message" id="successMessage">
          âœ… ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!
        </div>
      </div>
    </div>

    <script>
      // ìë™ì™„ì„± ê¸°ëŠ¥ ì„¤ì •
      function setupAutocomplete() {
        const searchInput = document.getElementById("nameSearch");
        const suggestionsDiv = document.getElementById("suggestions");
        const memberCount = document.getElementById("memberCount");
        const hiddenInput = document.getElementById("selectedMemberId");
        let allMembers = [];

        // ëª¨ë“  ë©¤ë²„ ë°ì´í„° ì €ì¥
        window.setMembersData = function(members) {
          allMembers = members;
          memberCount.textContent = `ì´ ${members.length}ëª…`;
        };

        // ì œì•ˆ ëª©ë¡ í‘œì‹œ
        function showSuggestions(members) {
          suggestionsDiv.innerHTML = "";
          
          if (members.length === 0) {
            suggestionsDiv.classList.remove("show");
            return;
          }

          members.forEach((member) => {
            const item = document.createElement("div");
            item.className = "suggestion-item";
            item.dataset.id = member.id;
            item.dataset.name = member.name;
            
            let detailsText = [];
            if (member.group) detailsText.push(member.group);
            if (member.location) detailsText.push(member.location);
            
            item.innerHTML = `
              <div class="name">${member.name}</div>
              ${detailsText.length > 0 ? `<div class="details">${detailsText.join(' Â· ')}</div>` : ''}
            `;
            
            item.addEventListener("click", () => {
              selectMember(member);
            });
            
            suggestionsDiv.appendChild(item);
          });

          suggestionsDiv.classList.add("show");
          memberCount.textContent = `${members.length}ëª… í‘œì‹œ / ì „ì²´ ${allMembers.length}ëª…`;
        }

        // ë©¤ë²„ ì„ íƒ
        function selectMember(member) {
          searchInput.value = member.name;
          hiddenInput.value = member.id;
          suggestionsDiv.classList.remove("show");
          suggestionsDiv.innerHTML = "";
        }

        // ê²€ìƒ‰ ì…ë ¥ ì²˜ë¦¬
        searchInput.addEventListener("input", (e) => {
          const searchTerm = e.target.value.trim().toLowerCase();
          hiddenInput.value = ""; // ì…ë ¥ ì¤‘ì—ëŠ” ì„ íƒ ì´ˆê¸°í™”

          if (searchTerm === "") {
            suggestionsDiv.classList.remove("show");
            memberCount.textContent = `ì´ ${allMembers.length}ëª…`;
            return;
          }

          // ê²€ìƒ‰ì–´ë¡œ í•„í„°ë§
          const filtered = allMembers.filter((m) =>
            m.name.toLowerCase().includes(searchTerm)
          );

          if (filtered.length === 1) {
            // ì •í™•íˆ 1ëª…ë§Œ ë§¤ì¹­ë˜ë©´ ìë™ ì„ íƒ
            selectMember(filtered[0]);
          } else if (filtered.length > 1) {
            // ì—¬ëŸ¬ ëª…ì´ë©´ ì„ íƒ ëª©ë¡ í‘œì‹œ
            showSuggestions(filtered);
          } else {
            // ê²°ê³¼ ì—†ìŒ
            suggestionsDiv.innerHTML = '<div class="suggestion-item">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>';
            suggestionsDiv.classList.add("show");
            memberCount.textContent = `0ëª… í‘œì‹œ / ì „ì²´ ${allMembers.length}ëª…`;
          }
        });

        // í¬ì»¤ìŠ¤ ì‹œ ì „ì²´ ëª©ë¡ í‘œì‹œ
        searchInput.addEventListener("focus", () => {
          if (searchInput.value.trim() === "") {
            showSuggestions(allMembers);
          }
        });

        // Enter í‚¤ë¡œ ì²« ë²ˆì§¸ í•­ëª© ì„ íƒ
        searchInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            const firstItem = suggestionsDiv.querySelector(".suggestion-item");
            if (firstItem && firstItem.dataset.id) {
              const member = allMembers.find(m => m.id === firstItem.dataset.id);
              if (member) selectMember(member);
            }
          }
        });

        // í™”ë©´ ë°– í´ë¦­ ì‹œ ë‹«ê¸°
        document.addEventListener("click", (e) => {
          const wrapper = document.querySelector(".select-wrapper");
          if (wrapper && !wrapper.contains(e.target)) {
            suggestionsDiv.classList.remove("show");
          }
        });
      }

      // ë©¤ë²„ ëª©ë¡ ë¡œë“œ
      async function loadMembers() {
        try {
          const response = await fetch("/.netlify/functions/get-members");

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const data = await response.json();

          if (data.members && data.members.length > 0) {
            console.log("âœ… ë©¤ë²„ ë¡œë“œ ì„±ê³µ:", data.members.length);
            
            // ìë™ì™„ì„± ì‹œìŠ¤í…œì— ë©¤ë²„ ë°ì´í„° ì „ë‹¬
            window.setMembersData(data.members);
            
            // ìë™ì™„ì„± ê¸°ëŠ¥ í™œì„±í™”
            setupAutocomplete();
          } else {
            throw new Error("ë©¤ë²„ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");
          }
        } catch (error) {
          console.error("âŒ ë©¤ë²„ ë¡œë“œ ì‹¤íŒ¨:", error);
          alert("ë©¤ë²„ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\nê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.");
        }
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì • ë° ë©¤ë²„ ë¡œë“œ
      window.addEventListener("DOMContentLoaded", () => {
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("date").value = today;
        loadMembers();
      });

      // í¼ ì œì¶œ
      document
        .getElementById("runningForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const nameSearch = document.getElementById("nameSearch");
          const memberId = document.getElementById("selectedMemberId").value;
          
          // ë©¤ë²„ ì„ íƒ í™•ì¸
          if (!memberId) {
            alert("ì´ë¦„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
            nameSearch.focus();
            return;
          }

          const formData = {
            memberId: memberId,
            name: nameSearch.value,
            date: document.getElementById("date").value,
            duration: document.getElementById("duration").value,
            title: document.getElementById("title").value,
            before: document.getElementById("before").value,
            during: document.getElementById("during").value,
            after: document.getElementById("after").value,
          };

          // ê²°ê³¼ í…ìŠ¤íŠ¸ ìƒì„±
          const resultText = `ğŸ“ ì˜¤ëŠ˜ì˜ ë§ˆì¸ë“œí’€ëŸ¬ë‹ ê¸°ë¡

${formData.name} | ${formData.date} | ${formData.duration}ë¶„

ğŸƒ ì˜¤ëŠ˜ì˜ í•œì¤„: ${formData.title}

ğŸ’­ ë‹¬ë¦¬ê¸° ì „: ${formData.before}
ğŸƒâ€â™‚ï¸ ë‹¬ë¦¬ê¸° ì¤‘: ${formData.during}
âœ¨ ë‹¬ë¦¬ê¸° í›„: ${formData.after}`;

          // ê²°ê³¼ í‘œì‹œ
          document.getElementById("resultText").textContent = resultText;
          document.getElementById("resultContainer").classList.add("show");

          // Notionì— ì €ì¥
          await saveToNotion(formData);
        });

      // Notion ì €ì¥ (Netlify Function ì‚¬ìš©)
      async function saveToNotion(formData) {
        const loadingEl = document.querySelector(".loading");
        const errorEl = document.querySelector(".error-message");
        const submitBtn = document.querySelector('button[type="submit"]');

        loadingEl.classList.add("show");
        errorEl.classList.remove("show");
        submitBtn.disabled = true;

        try {
          const response = await fetch("/.netlify/functions/save-to-notion", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(formData),
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error || "Notion ì €ì¥ ì‹¤íŒ¨");
          }

          loadingEl.classList.remove("show");
          console.log("âœ… Notionì— ì €ì¥ ì™„ë£Œ!");
        } catch (error) {
          console.error("Notion ì €ì¥ ì—ëŸ¬:", error);
          loadingEl.classList.remove("show");
          errorEl.textContent = `âš ï¸ ${error.message}`;
          errorEl.classList.add("show");
        } finally {
          submitBtn.disabled = false;
        }
      }

      // í´ë¦½ë³´ë“œ ë³µì‚¬
      function copyToClipboard() {
        const text = document.getElementById("resultText").textContent;
        navigator.clipboard.writeText(text).then(() => {
          const msg = document.getElementById("successMessage");
          msg.classList.add("show");
          setTimeout(() => msg.classList.remove("show"), 2000);
        });
      }

      // ë¦¬ë”ë³´ë“œ í˜ì´ì§€ë¡œ ì´ë™
      function goToLeaderboard() {
        window.location.href = "/leaderboard.html";
      }
    </script>
  </body>
</html>
