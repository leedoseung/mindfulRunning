<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ğŸ† ë§ˆì¸ë“œí’€ëŸ¬ë‹ ë¦¬ë”ë³´ë“œ</title>

    <!-- íŒŒë¹„ì½˜ -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />

    <!-- Web App Manifest -->
    <link rel="manifest" href="/manifest.json" />

    <!-- iOS ì›¹ì•± ì„¤ì • -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="apple-mobile-web-app-title" content="ë§ˆì¸ë“œí’€ëŸ¬ë‹" />
    <link rel="apple-touch-icon" href="/icon-192.png" />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 0;
        overflow-x: hidden;
      }

      .container {
        max-width: 100%;
        margin: 0;
        padding: 20px 0 0 0;
      }

      .header {
        text-align: center;
        margin-bottom: 20px;
        padding: 0 20px;
        animation: fadeInDown 0.8s ease-out;
      }

      .header h1 {
        color: white;
        font-size: 42px;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
      }

      .header p {
        color: rgba(255, 255, 255, 0.9);
        font-size: 18px;
      }

      /* ì •ë ¬ ë²„íŠ¼ */
      .sort-buttons {
        display: none;
      }

      /* ê²€ìƒ‰ ë°•ìŠ¤ */
      .search-box {
        background: white;
        border-radius: 0;
        padding: 15px 20px;
        margin-bottom: 0;
        box-shadow: none;
        border-bottom: 1px solid #e0e0e0;
      }

      .search-input {
        width: 100%;
        padding: 12px 20px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 16px;
        transition: border-color 0.3s ease;
      }

      .search-input:focus {
        outline: none;
        border-color: #667eea;
      }

      /* Grid í…Œì´ë¸” */
      .table-container {
        background: white;
        border-radius: 0;
        overflow-x: auto;
        overflow-y: hidden;
        box-shadow: none;
        -webkit-overflow-scrolling: touch;
      }

      .table-content {
        display: flex;
        flex-direction: column;
        min-width: 100%;
        width: 100%;
      }

      .table-header {
        display: grid;
        grid-template-columns: 1.5fr 1fr 1.2fr 1fr 1.2fr 1.2fr;
        background: #f8f9fa;
        color: #555;
        padding: 16px 20px;
        font-weight: 700;
        font-size: 14px;
        gap: 10px;
        align-items: center;
        user-select: none;
        border-bottom: 2px solid #e0e0e0;
        position: sticky;
        top: 0;
        z-index: 10;
      }

      .table-header > div {
        white-space: nowrap;
      }

      /* ì •ë ¬ ê°€ëŠ¥í•œ í—¤ë” ì…€ */
      .sortable {
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: opacity 0.2s ease;
      }

      .sortable:hover {
        opacity: 0.8;
      }

      .sort-arrow {
        font-size: 12px;
        opacity: 0.6;
        transition: opacity 0.2s ease;
      }

      .sortable.active .sort-arrow {
        opacity: 1;
      }

      .table-rows {
        display: flex;
        flex-direction: column;
        max-height: none;
        overflow-y: visible;
      }

      .table-row {
        display: grid;
        grid-template-columns: 1.5fr 1fr 1.2fr 1fr 1.2fr 1.2fr;
        padding: 18px 20px;
        border-bottom: 1px solid #f0f0f0;
        font-size: 16px;
        gap: 10px;
        align-items: center;
        transition: background-color 0.2s ease;
      }

      .table-row:hover {
        background-color: #f8f9fa;
      }

      .table-row:last-child {
        border-bottom: none;
      }

      /* ì´ë¦„ ì—´ */
      .name-cell {
        font-weight: 600;
        color: #667eea;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .name-cell:hover {
        color: #764ba2;
        text-decoration: underline;
      }

      /* ìˆ«ì ì—´ë“¤ */
      .number-cell {
        text-align: center;
        font-weight: 600;
        color: #333;
        font-size: 16px;
      }

      /* ê·¸ë£¹ ì—´ */
      .group-cell {
        text-align: center;
        color: #555;
        font-size: 15px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* ì£¼í™œë™ ì—´ */
      .location-cell {
        text-align: center;
        color: #555;
        font-size: 15px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* ì¸ìŠ¤íƒ€ ì—´ */
      .insta-cell {
        text-align: center;
        color: #e1306c;
        font-weight: 600;
        font-size: 15px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .loading {
        text-align: center;
        color: white;
        font-size: 24px;
        padding: 100px 20px;
      }

      .loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        margin: 20px auto;
        animation: spin 1s linear infinite;
      }

      .diary-loading {
        text-align: center;
        padding: 60px 20px;
      }

      .diary-loading-spinner {
        width: 60px;
        height: 60px;
        border: 5px solid #f0f0f0;
        border-top-color: #667eea;
        border-right-color: #764ba2;
        border-radius: 50%;
        margin: 0 auto 20px;
        animation: spin 1s ease-in-out infinite;
      }

      .diary-loading-text {
        color: #667eea;
        font-size: 16px;
        font-weight: 600;
        animation: pulse 1.5s ease-in-out infinite;
      }

      .diary-loading-emoji {
        font-size: 32px;
        margin-bottom: 15px;
        animation: bounce 1s ease-in-out infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      @keyframes pulse {
        0%, 100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      @keyframes bounce {
        0%, 100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-10px);
        }
      }

      /* ì—ëŸ¬ ë©”ì‹œì§€ */
      .error-message {
        background: white;
        padding: 30px;
        border-radius: 20px;
        text-align: center;
        color: #e74c3c;
        margin-top: 50px;
      }

      /* ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ */
      .refresh-button {
        background: white;
        color: #667eea;
        border: none;
        padding: 15px 30px;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        margin-top: 30px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        transition: transform 0.2s;
      }

      .refresh-button:hover {
        transform: translateY(-2px);
      }

      /* ì• ë‹ˆë©”ì´ì…˜ */
      @keyframes fadeInDown {
        from {
          opacity: 0;
          transform: translateY(-30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* ë°˜ì‘í˜• - ëª¨ë°”ì¼ */
      @media (max-width: 768px) {
        .header h1 {
          font-size: 28px;
        }

        .table-header,
        .table-row {
          font-size: 14px;
          padding: 14px 12px;
          gap: 8px;
        }

        .name-cell {
          font-size: 14px;
        }

        .number-cell {
          font-size: 14px;
        }

        .group-cell,
        .location-cell {
          font-size: 13px;
        }

        .insta-cell {
          font-size: 13px;
        }
      }

      @media (max-width: 480px) {
        .container {
          padding: 10px 0 0 0;
        }

        .header h1 {
          font-size: 24px;
          margin-bottom: 8px;
        }

        .header p {
          font-size: 14px;
        }

        .search-box {
          padding: 12px 15px;
        }

        .table-header,
        .table-row {
          font-size: 13px;
          padding: 14px 10px;
          gap: 6px;
        }

        .name-cell {
          font-size: 13px;
        }

        .number-cell {
          font-size: 13px;
        }

        .group-cell,
        .location-cell {
          font-size: 12px;
        }

        .insta-cell {
          font-size: 12px;
        }
      }

      /* í™ˆ ë²„íŠ¼ */
      .home-button {
        position: fixed;
        bottom: 30px;
        right: 30px;
        background: white;
        color: #667eea;
        text-decoration: none;
        padding: 15px 25px;
        border-radius: 50px;
        font-weight: 600;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        transition: transform 0.2s;
        z-index: 100;
      }

      .home-button:hover {
        transform: scale(1.1);
      }

      /* ì˜¤ëŠ˜ì˜ ëŸ¬ë‹ ê¸°ë¡ ë²„íŠ¼ - ìˆ¨ê¹€ */
      .today-record-button {
        display: none;
      }

      /* ë ˆì´ì–´ íŒì—… */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .modal-overlay.active {
        display: flex;
      }

      .modal-content {
        background: white;
        border-radius: 20px;
        padding: 30px;
        max-width: 600px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        animation: slideUp 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        position: relative;
      }

      @keyframes slideUp {
        0% {
          opacity: 0;
          transform: translateY(100px) scale(0.8) rotate(-2deg);
        }
        60% {
          opacity: 1;
          transform: translateY(-10px) scale(1.02) rotate(1deg);
        }
        80% {
          transform: translateY(5px) scale(0.98) rotate(-0.5deg);
        }
        100% {
          opacity: 1;
          transform: translateY(0) scale(1) rotate(0deg);
        }
      }

      .modal-close {
        position: absolute;
        top: 15px;
        right: 15px;
        background: none;
        border: none;
        font-size: 28px;
        color: #999;
        cursor: pointer;
        padding: 5px 10px;
        line-height: 1;
        transition: color 0.2s;
      }

      .modal-close:hover {
        color: #333;
      }

      .modal-header {
        text-align: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
      }

      .modal-header h2 {
        color: #667eea;
        font-size: 24px;
        margin-bottom: 10px;
      }

      .modal-header .subtitle {
        color: #999;
        font-size: 14px;
      }

      .record-field {
        margin-bottom: 20px;
      }

      .record-field label {
        display: block;
        font-weight: 600;
        color: #667eea;
        margin-bottom: 8px;
        font-size: 14px;
      }

      .record-field .value {
        color: #333;
        font-size: 16px;
        line-height: 1.6;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 10px;
        white-space: pre-wrap;
        word-break: break-word;
      }

      .record-field .value.empty {
        color: #999;
        font-style: italic;
      }

      .no-records-message {
        text-align: center;
        padding: 40px 20px;
        color: #999;
        font-size: 16px;
      }

      /* ì¼ê¸°ì¥ ìŠ¤íƒ€ì¼ ëª¨ë‹¬ */
      .diary-modal-content {
        max-width: 800px;
      }

      .diary-entry {
        background: #fff9f0;
        border-left: 4px solid #667eea;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        position: relative;
      }

      .diary-entry-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px dashed #e0e0e0;
      }

      .diary-date {
        font-weight: 700;
        color: #667eea;
        font-size: 18px;
      }

      .diary-meta {
        color: #999;
        font-size: 14px;
      }

      .diary-content {
        font-family: "Nanum Gothic", sans-serif;
        line-height: 1.8;
        color: #333;
        white-space: pre-wrap;
        word-break: break-word;
      }

      .copy-button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
      }

      .copy-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5);
      }

      .copy-button:active {
        transform: translateY(0);
      }

      .copy-all-button {
        margin-bottom: 20px;
        width: 100%;
        padding: 12px 24px;
        font-size: 15px;
        font-weight: 600;
      }

      /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
      @media (max-width: 480px) {
        .today-record-button {
          bottom: 90px;
          right: 20px;
          padding: 12px 20px;
          font-size: 13px;
        }

        .modal-content {
          padding: 20px;
          max-height: 85vh;
        }

        .modal-header h2 {
          font-size: 20px;
        }

        .record-field label {
          font-size: 13px;
        }

        .record-field .value {
          font-size: 14px;
          padding: 10px;
        }

        .diary-entry {
          padding: 15px;
        }

        .diary-date {
          font-size: 16px;
        }

        .diary-meta {
          font-size: 12px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>
          <img
            src="/favicon.ico"
            alt="ë¦¬ë”ë³´ë“œ"
            style="
              width: 40px;
              height: 40px;
              vertical-align: middle;
              margin-right: 10px;
            "
          />
          ë§ˆì¸ë“œí’€ëŸ¬ë‹ ë¦¬ë”ë³´ë“œ
        </h1>
        <p>
          ë‚´ê°€ í•  ìˆ˜ ìˆëŠ” ë‹¬ë¦¬ê¸°ë¥¼ í•˜ë‹¤ë³´ë©´, ë‚´ê°€ í•  ìˆ˜ ì—†ë˜ ë‹¬ë¦¬ê¸°ë¥¼ í•˜ê²Œëœë‹¤.
        </p>
      </div>

      <!-- ê²€ìƒ‰ ë°•ìŠ¤ -->
      <div class="search-box">
        <input
          type="text"
          class="search-input"
          id="searchInput"
          placeholder="ğŸ” íšŒì› ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰í•˜ì„¸ìš”..."
        />
      </div>

      <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <p>ë¦¬ë”ë³´ë“œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
      </div>

      <!-- Grid í…Œì´ë¸” -->
      <div class="table-container" id="tableContainer" style="display: none">
        <div class="table-header">
          <div>ì´ë¦„</div>
          <div class="sortable active" data-sort="count">
            íšŸìˆ˜
            <span class="sort-arrow" id="countArrow">â†“</span>
          </div>
          <div class="sortable" data-sort="time">
            ì‹œê°„(ë¶„)
            <span class="sort-arrow">â†‘â†“</span>
          </div>
          <div>ê·¸ë£¹</div>
          <div>ì¸ìŠ¤íƒ€</div>
          <div>ì£¼í™œë™</div>
        </div>
        <div class="table-rows" id="tableRows"></div>
      </div>

      <div id="errorContainer"></div>
    </div>

    <button class="today-record-button" id="todayRecordButton">
      ğŸ“– ì˜¤ëŠ˜ì˜ ëŸ¬ë‹ ê¸°ë¡
    </button>

    <a href="/" class="home-button">ğŸƒ ê¸°ë¡í•˜ëŸ¬ ê°€ê¸°</a>

    <!-- ë ˆì´ì–´ íŒì—… - ëœë¤ ê¸°ë¡ -->
    <div class="modal-overlay" id="modalOverlay">
      <div class="modal-content">
        <button class="modal-close" id="modalClose">&times;</button>
        <div class="modal-header">
          <h2>ğŸƒ ì•„ë¦„ë‹¤ìš´ ë‹¬ë¦¬ê¸° ì¶”ì–µë“¤..</h2>
          <p class="subtitle" id="modalSubtitle">ë¡œë”© ì¤‘...</p>
        </div>
        <div id="modalBody">
          <div class="loading" style="padding: 40px 20px;">
            <div class="loading-spinner" style="width: 40px; height: 40px;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ë ˆì´ì–´ íŒì—… - ë©¤ë²„ ì¼ê¸°ì¥ -->
    <div class="modal-overlay" id="diaryModalOverlay">
      <div class="modal-content diary-modal-content">
        <button class="modal-close" id="diaryModalClose">&times;</button>
        <div class="modal-header">
          <h2>ğŸ“– <span id="diaryMemberName"></span>ë‹˜ì˜ ëŸ¬ë‹ ì¼ê¸°</h2>
          <p class="subtitle" id="diarySubtitle">ì´ <span id="diaryRecordCount">0</span>ê°œì˜ ê¸°ë¡</p>
        </div>
        <div id="diaryBody">
          <div class="loading" style="padding: 40px 20px;">
            <div class="loading-spinner" style="width: 40px; height: 40px;"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Service Worker ë“±ë¡
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
            .then((registration) => {
              console.log('âœ… Service Worker ë“±ë¡ ì„±ê³µ:', registration.scope);
            })
            .catch((error) => {
              console.log('âŒ Service Worker ë“±ë¡ ì‹¤íŒ¨:', error);
            });
        });
      }

      let currentData = null;
      let currentSort = { field: "count", ascending: false };
      let filteredData = [];

      // ë¦¬ë”ë³´ë“œ ë°ì´í„° ë¡œë“œ
      async function loadLeaderboard() {
        try {
          const response = await fetch("/.netlify/functions/get-leaderboard");

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const data = await response.json();

          if (data.leaderboard && data.leaderboard.length > 0) {
            currentData = data;
            filteredData = [...data.leaderboard];
            sortAndDisplay("count", false); // ê¸°ë³¸ ì •ë ¬: íšŸìˆ˜ ë‚´ë¦¼ì°¨ìˆœ
            return data; // ë°ì´í„° ë°˜í™˜
          } else {
            showError("ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.");
            return null;
          }
        } catch (error) {
          console.error("ë¦¬ë”ë³´ë“œ ë¡œë“œ ì‹¤íŒ¨:", error);
          showError("ë¦¬ë”ë³´ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          return null;
        }
      }

      // ì •ë ¬ ë° í‘œì‹œ
      function sortAndDisplay(field, ascending) {
        if (!currentData) return;

        let sorted = [...filteredData];

        if (field === "count") {
          sorted.sort((a, b) =>
            ascending ? a.count - b.count : b.count - a.count,
          );
        } else if (field === "time") {
          sorted.sort((a, b) =>
            ascending ? a.totalTime - b.totalTime : b.totalTime - a.totalTime,
          );
        }

        currentSort = { field, ascending };
        updateSortArrows();
        displayLeaderboard(sorted);
      }

      // ì •ë ¬ í™”ì‚´í‘œ ì—…ë°ì´íŠ¸
      function updateSortArrows() {
        const sortables = document.querySelectorAll(".sortable");
        sortables.forEach((el) => {
          const field = el.getAttribute("data-sort");
          const arrow = el.querySelector(".sort-arrow");

          if (field === currentSort.field) {
            el.classList.add("active");
            arrow.textContent = currentSort.ascending ? "â†‘" : "â†“";
          } else {
            el.classList.remove("active");
            arrow.textContent = field === "count" ? "â†“" : "â†‘â†“";
          }
        });
      }

      // ë¦¬ë”ë³´ë“œ í…Œì´ë¸” í‘œì‹œ
      function displayLeaderboard(members) {
        const tableContainer = document.getElementById("tableContainer");
        const tableRows = document.getElementById("tableRows");
        const loadingEl = document.getElementById("loading");

        tableRows.innerHTML = "";

        if (members.length === 0) {
          tableRows.innerHTML =
            '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #999;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        } else {
          // ëª¨ë“  ë©¤ë²„ í‘œì‹œ
          members.forEach((member) => {
            const row = createTableRow(member);
            tableRows.appendChild(row);
          });
        }

        // ë¡œë”© ìˆ¨ê¸°ê³  í…Œì´ë¸” í‘œì‹œ
        loadingEl.style.display = "none";
        tableContainer.style.display = "block";
      }

      // í…Œì´ë¸” í–‰ ìƒì„±
      function createTableRow(member) {
        const row = document.createElement("div");
        row.className = "table-row";

        // ë‹¬ë¦°ì‹œê°„ ì˜¬ë¦¼ (ì†Œìˆ˜ì  ì˜¬ë¦¼í•˜ì—¬ ì •ìˆ˜)
        const ceiledTime = Math.ceil(member.totalTime);

        row.innerHTML = `
          <div class="name-cell" data-member-id="${member.id}" data-member-name="${member.name}">${member.name}</div>
          <div class="number-cell">${member.count}</div>
          <div class="number-cell">${ceiledTime}</div>
          <div class="group-cell">${member.group || "-"}</div>
          <div class="insta-cell">${member.instaId || "-"}</div>
          <div class="location-cell">${member.location || "-"}</div>
        `;

        // ì´ë¦„ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
        const nameCell = row.querySelector(".name-cell");
        nameCell.addEventListener("click", () => {
          showMemberDiary(member.id, member.name, member.count);
        });

        return row;
      }

      // ê²€ìƒ‰ í•„í„°ë§
      function filterBySearch(keyword) {
        if (!currentData) return;

        if (!keyword.trim()) {
          filteredData = [...currentData.leaderboard];
        } else {
          const searchLower = keyword.toLowerCase();
          filteredData = currentData.leaderboard.filter((member) =>
            member.name.toLowerCase().includes(searchLower),
          );
        }

        sortAndDisplay(currentSort.field, currentSort.ascending);
      }

      // ì—ëŸ¬ í‘œì‹œ
      function showError(message) {
        const loadingEl = document.getElementById("loading");
        const errorContainer = document.getElementById("errorContainer");

        loadingEl.style.display = "none";

        errorContainer.innerHTML = `
          <div class="error-message">
            <h2>ğŸ˜¢ ${message}</h2>
            <button class="refresh-button" onclick="location.reload()">
              ğŸ”„ ìƒˆë¡œê³ ì¹¨
            </button>
          </div>
        `;
      }

      // í—¤ë” ì •ë ¬ ë²„íŠ¼ ì´ë²¤íŠ¸
      document.querySelectorAll(".sortable").forEach((el) => {
        el.addEventListener("click", function () {
          const field = this.getAttribute("data-sort");
          const isCurrentField = field === currentSort.field;
          const ascending = isCurrentField ? !currentSort.ascending : false;
          sortAndDisplay(field, ascending);
        });
      });

      // ê²€ìƒ‰ ì…ë ¥ ì´ë²¤íŠ¸
      document
        .getElementById("searchInput")
        .addEventListener("input", function () {
          filterBySearch(this.value);
        });

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
      window.addEventListener("DOMContentLoaded", async () => {
        await loadLeaderboard();
        // ë¦¬ë”ë³´ë“œ ë¡œë“œ ì™„ë£Œ í›„ íŒì—… í‘œì‹œ
        setTimeout(() => {
          showTodayRecord();
        }, 500);
      });

      // ì˜¤ëŠ˜ì˜ ëŸ¬ë‹ ê¸°ë¡ íŒì—…
      const modalOverlay = document.getElementById("modalOverlay");
      const modalClose = document.getElementById("modalClose");
      const modalBody = document.getElementById("modalBody");
      const modalSubtitle = document.getElementById("modalSubtitle");

      // íŒì—… ì—´ê¸° í•¨ìˆ˜
      async function showTodayRecord() {
        try {
          // ìºì‹œ í™•ì¸ (5ë¶„ê°„ ìœ íš¨)
          const cacheKey = 'todayRecordsCache';
          const cacheTimeKey = 'todayRecordsCacheTime';
          const cacheValidDuration = 5 * 60 * 1000; // 5ë¶„

          const cachedData = localStorage.getItem(cacheKey);
          const cacheTime = localStorage.getItem(cacheTimeKey);

          let data;

          if (cachedData && cacheTime && (Date.now() - parseInt(cacheTime)) < cacheValidDuration) {
            // ìºì‹œëœ ë°ì´í„° ì‚¬ìš©
            console.log("Using cached data");
            data = JSON.parse(cachedData);
          } else {
            // ìƒˆë¡œ ë°ì´í„° ë¡œë“œ
            console.log("Fetching fresh data");
            const response = await fetch("/.netlify/functions/get-today-records");

            console.log("API Response status:", response.status);

            if (!response.ok) {
              const errorData = await response.json().catch(() => ({}));
              console.error("API Error:", errorData);
              throw new Error(`HTTP ${response.status}: ${JSON.stringify(errorData)}`);
            }

            data = await response.json();

            // ìºì‹œì— ì €ì¥
            localStorage.setItem(cacheKey, JSON.stringify(data));
            localStorage.setItem(cacheTimeKey, Date.now().toString());
          }

          console.log("API Response data:", data);

          if (data.records && data.records.length > 0) {
            // ëœë¤ìœ¼ë¡œ í•˜ë‚˜ ì„ íƒ
            const randomIndex = Math.floor(Math.random() * data.records.length);
            const record = data.records[randomIndex];

            // ë©¤ë²„ IDë¥¼ ì´ë¦„ìœ¼ë¡œ ë³€í™˜ (leaderboard ë°ì´í„° í™œìš©)
            if (currentData && currentData.leaderboard) {
              const member = currentData.leaderboard.find(m => m.id === record.name);
              if (member) {
                record.name = member.name;
              }
            }

            // ë°ì´í„° ì¤€ë¹„ ì™„ë£Œ í›„ íŒì—… í‘œì‹œ
            displayRecord(record, record.date);
            modalOverlay.classList.add("active");
          } else {
            modalBody.innerHTML = `
              <div class="no-records-message">
                <p>ğŸ˜¢ ê¸°ë¡ëœ ëŸ¬ë‹ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                <p style="font-size: 14px; margin-top: 10px;">í•¨ê»˜ ë‹¬ë ¤ìš”!</p>
              </div>
            `;
            modalSubtitle.textContent = "ë°ì´í„° ì—†ìŒ";
          }
        } catch (error) {
          console.error("ëŸ¬ë‹ ê¸°ë¡ ë¡œë“œ ì‹¤íŒ¨:", error);
          modalBody.innerHTML = `
            <div class="no-records-message">
              <p style="color: #e74c3c;">ğŸ˜¢ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>
              <p style="font-size: 12px; margin-top: 10px; color: #666;">
                ì—ëŸ¬: ${error.message}
              </p>
            </div>
          `;
          modalSubtitle.textContent = "ì˜¤ë¥˜ ë°œìƒ";
        }
      }

      // ê¸°ë¡ í‘œì‹œ í•¨ìˆ˜
      function displayRecord(record, date) {
        modalSubtitle.textContent = `${record.name} ë‹˜ì˜ ê¸°ë¡ (${date})`;

        const formatValue = (value) => {
          return value && value.trim() !== ""
            ? `<div class="value">${value}</div>`
            : `<div class="value empty">ê¸°ë¡ ì—†ìŒ</div>`;
        };

        modalBody.innerHTML = `
          <div class="record-field">
            <label>ğŸ“… ë‹¬ë¦° ë‚ ì§œ</label>
            ${formatValue(record.date)}
          </div>
          <div class="record-field">
            <label>â±ï¸ ë‹¬ë¦° ì‹œê°„</label>
            ${formatValue(record.duration ? `${record.duration}ë¶„` : "")}
          </div>
          <div class="record-field">
            <label>ğŸ“ ë‹¬ë¦° ì¥ì†Œ</label>
            ${formatValue(record.location)}
          </div>
          <div class="record-field">
            <label>ğŸ“ ì˜¤ëŠ˜ì˜ í•œì¤„ ì œëª©/Story</label>
            ${formatValue(record.title)}
          </div>
          <div class="record-field">
            <label>ğŸ’­ ë‹¬ë¦¬ê¸° ì „ ìƒê°/ëŠë‚Œ</label>
            ${formatValue(record.before)}
          </div>
          <div class="record-field">
            <label>ğŸƒ ë‹¬ë¦¬ê¸° ì¤‘ ìƒê°/ëŠë‚Œ</label>
            ${formatValue(record.during)}
          </div>
          <div class="record-field">
            <label>âœ¨ ë‹¬ë¦¬ê¸° í›„ ìƒê°/ëŠë‚Œ</label>
            ${formatValue(record.after)}
          </div>
        `;
      }

      // íŒì—… ë‹«ê¸°
      modalClose.addEventListener("click", () => {
        modalOverlay.classList.remove("active");
      });

      // ì˜¤ë²„ë ˆì´ í´ë¦­ ì‹œ ë‹«ê¸°
      modalOverlay.addEventListener("click", (e) => {
        if (e.target === modalOverlay) {
          modalOverlay.classList.remove("active");
        }
      });

      // === ë©¤ë²„ ì¼ê¸°ì¥ ê¸°ëŠ¥ ===
      const diaryModalOverlay = document.getElementById("diaryModalOverlay");
      const diaryModalClose = document.getElementById("diaryModalClose");
      const diaryBody = document.getElementById("diaryBody");
      const diaryMemberName = document.getElementById("diaryMemberName");
      const diaryRecordCount = document.getElementById("diaryRecordCount");

      // ë©¤ë²„ ì¼ê¸°ì¥ í‘œì‹œ
      async function showMemberDiary(memberId, memberName, expectedCount) {
        try {
          // ëª¨ë‹¬ ì—´ê¸°
          diaryModalOverlay.classList.add("active");
          diaryMemberName.textContent = memberName;
          diaryRecordCount.textContent = "0";

          // ë¡œë”© í‘œì‹œ
          diaryBody.innerHTML = `
            <div class="diary-loading">
              <div class="diary-loading-emoji">ğŸƒğŸ’¨</div>
              <div class="diary-loading-spinner"></div>
              <p class="diary-loading-text">ëŸ¬ë‹ ì¼ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
          `;

          // ìºì‹œ í™•ì¸ (1ì‹œê°„ ìœ íš¨)
          const cacheKey = `memberRecords_${memberId}`;
          const cacheTimeKey = `memberRecordsTime_${memberId}`;
          const cacheValidDuration = 60 * 60 * 1000; // 1ì‹œê°„

          const cachedData = localStorage.getItem(cacheKey);
          const cacheTime = localStorage.getItem(cacheTimeKey);

          let data;
          let useCache = false;

          // ìºì‹œê°€ ìˆê³  ìœ íš¨í•˜ë©´, ê¸°ë¡ ìˆ˜ê°€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
          if (cachedData && cacheTime && (Date.now() - parseInt(cacheTime)) < cacheValidDuration) {
            const parsed = JSON.parse(cachedData);
            const cachedCount = parsed.records?.length || 0;
            if (cachedCount === expectedCount) {
              console.log("Using cached data for:", memberName, `(${cachedCount}/${expectedCount} records match)`);
              data = parsed;
              useCache = true;
            } else {
              console.log("Cache invalidated: count mismatch", `(cached: ${cachedCount}, expected: ${expectedCount})`);
            }
          }

          if (!useCache) {
            console.log("Fetching fresh member records for:", memberName, "memberId:", memberId);
            const response = await fetch(`/.netlify/functions/get-member-records?memberId=${memberId}`);

            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
            }

            data = await response.json();
            console.log("API Response:", data);

            // ìºì‹œì— ì €ì¥
            localStorage.setItem(cacheKey, JSON.stringify(data));
            localStorage.setItem(cacheTimeKey, Date.now().toString());
          }

          if (data.records && data.records.length > 0) {
            diaryRecordCount.textContent = data.records.length;
            displayDiaryRecords(data.records, memberName);
          } else {
            diaryBody.innerHTML = `
              <div class="no-records-message">
                <p>ğŸ˜¢ ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                <p style="font-size: 14px; margin-top: 10px;">ì²« ëŸ¬ë‹ì„ ì‹œì‘í•´ë³´ì„¸ìš”!</p>
              </div>
            `;
          }
        } catch (error) {
          console.error("ë©¤ë²„ ê¸°ë¡ ë¡œë“œ ì‹¤íŒ¨:", error);
          diaryBody.innerHTML = `
            <div class="no-records-message">
              <p style="color: #e74c3c;">ğŸ˜¢ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>
              <p style="font-size: 12px; margin-top: 10px; color: #666;">
                ì—ëŸ¬: ${error.message}
              </p>
            </div>
          `;
        }
      }

      // ì¼ê¸°ì¥ í˜•ì‹ìœ¼ë¡œ ê¸°ë¡ í‘œì‹œ
      function displayDiaryRecords(records, memberName) {
        let html = `
          <button class="copy-button copy-all-button" onclick="copyAllRecords()">
            ğŸ“‹ ì „ì²´ ë³µì‚¬í•˜ê¸°
          </button>
        `;

        records.forEach((record, index) => {
          const displayText = formatRecordForDisplay(record, memberName);
          html += `
            <div class="diary-entry">
              <div class="diary-entry-header">
                <div class="diary-date">ğŸ“… ${record.date}</div>
                <div>
                  <span class="diary-meta">â±ï¸ ${record.duration}ë¶„</span>
                  <button class="copy-button" onclick="copyRecord(${index})" style="margin-left: 10px;">
                    ğŸ“‹ ë³µì‚¬
                  </button>
                </div>
              </div>
              <div class="diary-content" id="diary-record-${index}">${displayText}</div>
            </div>
          `;
        });

        diaryBody.innerHTML = html;

        // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (ë³µì‚¬ ê¸°ëŠ¥ìš©)
        window.currentDiaryRecords = records;
        window.currentDiaryMemberName = memberName;
      }

      // í™”ë©´ í‘œì‹œìš© í¬ë§·íŒ… (ë‚ ì§œ ì œì™¸)
      function formatRecordForDisplay(record, memberName) {
        let text = '';
        if (record.location) text += `ğŸ“ ${record.location}\n\n`;
        if (record.title) text += `âœï¸ ${record.title}\n\n`;
        if (record.before) text += `ğŸ’­ ë‹¬ë¦¬ê¸° ì „ ìƒê°/ëŠë‚Œ\n${record.before}\n\n`;
        if (record.during) text += `ğŸƒ ë‹¬ë¦¬ê¸° ì¤‘ ìƒê°/ëŠë‚Œ\n${record.during}\n\n`;
        if (record.after) text += `âœ¨ ë‹¬ë¦¬ê¸° í›„ ìƒê°/ëŠë‚Œ\n${record.after}\n\n`;
        text += `by ${memberName}`;

        return text;
      }

      // ê¸°ë¡ì„ ë³µì‚¬ í˜•ì‹ìœ¼ë¡œ í¬ë§·íŒ…
      function formatRecordForCopy(record, memberName) {
        let text = `ğŸ“… ${record.date}\n`;
        text += `â±ï¸ ${record.duration}ë¶„\n`;
        if (record.location) text += `ğŸ“ ${record.location}\n`;
        text += `\n`;
        if (record.title) text += `âœï¸ ${record.title}\n\n`;
        if (record.before) text += `ğŸ’­ ë‹¬ë¦¬ê¸° ì „ ìƒê°/ëŠë‚Œ\n${record.before}\n\n`;
        if (record.during) text += `ğŸƒ ë‹¬ë¦¬ê¸° ì¤‘ ìƒê°/ëŠë‚Œ\n${record.during}\n\n`;
        if (record.after) text += `âœ¨ ë‹¬ë¦¬ê¸° í›„ ìƒê°/ëŠë‚Œ\n${record.after}\n\n`;
        text += `by ${memberName}`;

        return text;
      }

      // ê°œë³„ ê¸°ë¡ ë³µì‚¬
      function copyRecord(index) {
        const record = window.currentDiaryRecords[index];
        const memberName = window.currentDiaryMemberName;
        const text = formatRecordForCopy(record, memberName);

        navigator.clipboard.writeText(text).then(() => {
          alert("âœ… ê¸°ë¡ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
        }).catch(err => {
          console.error("ë³µì‚¬ ì‹¤íŒ¨:", err);
          alert("âŒ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        });
      }

      // ì „ì²´ ê¸°ë¡ ë³µì‚¬
      function copyAllRecords() {
        const records = window.currentDiaryRecords;
        const memberName = window.currentDiaryMemberName;

        let allText = `ğŸ“– ${memberName}ë‹˜ì˜ ëŸ¬ë‹ ì¼ê¸° (ì´ ${records.length}ê°œ)\n`;
        allText += `${"=".repeat(50)}\n\n`;

        records.forEach((record, index) => {
          allText += formatRecordForCopy(record, memberName);
          if (index < records.length - 1) {
            allText += `\n\n${"-".repeat(50)}\n\n`;
          }
        });

        navigator.clipboard.writeText(allText).then(() => {
          alert("âœ… ì „ì²´ ê¸°ë¡ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
        }).catch(err => {
          console.error("ë³µì‚¬ ì‹¤íŒ¨:", err);
          alert("âŒ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        });
      }

      // ì¼ê¸°ì¥ íŒì—… ë‹«ê¸°
      diaryModalClose.addEventListener("click", () => {
        diaryModalOverlay.classList.remove("active");
      });

      // ì˜¤ë²„ë ˆì´ í´ë¦­ ì‹œ ë‹«ê¸°
      diaryModalOverlay.addEventListener("click", (e) => {
        if (e.target === diaryModalOverlay) {
          diaryModalOverlay.classList.remove("active");
        }
      });
    </script>
  </body>
</html>
